# 用户使用指南

## 快速开始

### 第一次使用

1. **检查文件结构**
   确保项目目录包含以下文件：
   ```
   ├── map.py              # 主程序
   ├── beijing.geojson     # 北京地图数据
   ├── shrink_ratio.csv    # 面积比例数据
   └── customer_num.csv    # 客户数量数据
   ```

2. **安装依赖**
   ```bash
   pip install geopandas matplotlib pandas numpy shapely pillow
   ```

3. **运行程序**
   ```bash
   python map.py
   ```

4. **查看结果**
   程序运行完成后，check `map_outputs` 目录：
   - `2022.png` - 2022年地图
   - `2023.png` - 2023年地图  
   - `2024.png` - 2024年地图
   - `2025.png` - 2025年地图
   - `beijing_map_animation.gif` - 动态GIF

## 数据准备指南

### CSV数据格式要求

#### shrink_ratio.csv (面积比例数据)
```csv
district,2022,2023,2024,2025
昌平区,0.95555,0.89525,0.76981,0.53213
朝阳区,0.95332,0.89316,0.86902,0.82327
...
```
- **第一列**: 行政区名称 (必须与GeoJSON中的名称匹配)
- **后续列**: 各年份的面积比例 (0.0-1.0之间的小数)
- **数据含义**: 0.8表示橙色区域占蓝色区域面积的80%

#### customer_num.csv (客户数量数据)
```csv
district,2022,2023,2024,2025
昌平区,2171,2034,1749,1209
朝阳区,11252,10542,10257,9717
...
```
- **第一列**: 行政区名称 (必须与shrink_ratio.csv一致)
- **后续列**: 各年份的客户数量 (正整数)
- **数据含义**: 数值越大，颜色越红；数值越小，颜色越黄

### 添加新年份数据

1. **修改CSV文件**
   ```csv
   district,2022,2023,2024,2025,2026
   昌平区,0.95555,0.89525,0.76981,0.53213,0.45000
   ```

2. **程序自动识别**
   - 程序会自动读取CSV文件的列名
   - 自动生成对应年份的地图
   - 无需修改代码

### 添加新行政区

1. **更新GeoJSON文件**
   - 确保新区域的几何数据在beijing.geojson中
   - 区域名称字段为'name'

2. **更新CSV文件**
   ```csv
   district,2022,2023,2024,2025
   新区域,0.8,0.7,0.6,0.5
   ```

3. **注意事项**
   - 区域名称必须精确匹配
   - 支持中文区域名
   - 如果CSV中没有某个区域的数据，该区域将显示为白色

## 自定义配置

### 修改颜色方案

在`map.py`中找到`calculate_color_by_customer_num`函数：

```python
def calculate_color_by_customer_num(customer_num, min_num, max_num):
    # 修改这两行来改变颜色范围
    bright_yellow = np.array([1.0, 1.0, 0.2])   # 起始颜色
    deep_red = np.array([0.8, 0.0, 0.0])        # 结束颜色
```

**常用颜色配置**:
- 绿色到红色: `[0.0, 1.0, 0.0]` → `[1.0, 0.0, 0.0]`
- 蓝色到橙色: `[0.0, 0.5, 1.0]` → `[1.0, 0.5, 0.0]`
- 紫色到黄色: `[0.5, 0.0, 1.0]` → `[1.0, 1.0, 0.0]`

### 调整对比度

修改非线性映射的指数：

```python
# 当前使用平方函数
enhanced_ratio = ratio ** 2

# 更强对比度 (立方)
enhanced_ratio = ratio ** 3

# 更柔和对比度 (开方)
enhanced_ratio = ratio ** 0.5
```

### 修改渐变效果

调整渐变层数量：

```python
# 在主程序中找到这一行
gradient_layers = create_gradient_layers(orange_geom, blue_geom, color, num_layers=8)

# 修改num_layers值
# 更多层次 (更平滑): num_layers=15
# 更少层次 (更锐利): num_layers=5
```

### 调整图像输出

修改图像尺寸和分辨率：

```python
# 找到这些行
fig, ax = plt.subplots(figsize=(12, 10))  # 图像尺寸
plt.savefig(output_file, dpi=300)         # 分辨率
```

**常用配置**:
- 高分辨率: `dpi=600`, `figsize=(16, 12)`
- 标准分辨率: `dpi=300`, `figsize=(12, 10)`
- 快速预览: `dpi=150`, `figsize=(8, 6)`

### 修改GIF动画

在`create_gif_from_images`函数中：

```python
images[0].save(
    gif_path,
    save_all=True,
    append_images=images[1:],
    duration=1000,  # 修改帧持续时间 (毫秒)
    loop=0         # 修改循环次数 (0=无限循环)
)
```

**动画配置建议**:
- 快速切换: `duration=500`
- 慢速切换: `duration=2000`
- 播放一次: `loop=1`
- 播放三次: `loop=3`

## 常见问题解决

### Q1: 中文字符显示为方框

**原因**: 系统缺少中文字体
**解决方案**:
```python
# 在map.py开头修改字体设置
plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'Arial Unicode MS']
```

### Q2: 某些区域显示为白色

**原因**: CSV文件中缺少该区域的数据
**解决方案**:
1. 检查区域名称拼写是否正确
2. 确认CSV文件包含所有需要的区域
3. 检查数据是否为空值

### Q3: 颜色差异不明显

**解决方案**:
1. 增加对比度指数 (改为`ratio ** 3`)
2. 调整颜色范围 (使用更对比强烈的颜色)
3. 检查客户数量数据的分布是否合理

### Q4: 程序运行缓慢

**原因和解决方案**:
- 渐变层过多: 减少`num_layers`参数
- 图像分辨率过高: 降低`dpi`值
- 数据量过大: 考虑数据预处理

### Q5: GIF文件过大

**解决方案**:
1. 降低图像分辨率: `dpi=200`
2. 减少图像尺寸: `figsize=(10, 8)`
3. 优化颜色数量 (GIF限制256色)

### Q6: 某个年份生成失败

**检查步骤**:
1. 确认CSV文件包含该年份的列
2. 检查数据格式是否正确 (数字而非文本)
3. 查看控制台错误信息

## 数据解读指南

### 地图颜色含义

- **🟡 黄色系**: 客户数量较少的区域
- **🟠 橙色系**: 客户数量中等的区域
- **🔴 红色系**: 客户数量较多的区域
- **🔵 蓝色**: 流失客户区域 (橙色区域外的部分)
- **⚪ 白色**: 无数据区域

### 区域大小含义

- **橙色区域大小**: 反映该区域的客户回厂比例
- **区域越大**: 回厂客户比例越高
- **区域越小**: 回厂客户比例越低

### 时间变化分析

通过观察GIF动画可以分析：
1. **整体趋势**: 橙色区域变化反映总体趋势
2. **区域对比**: 不同区域的变化速度和幅度对比
3. **颜色变化**: 客户数量的时间变化规律

## 输出文件说明

### PNG文件特点
- **高分辨率**: 300 DPI，适合打印
- **真彩色**: RGB模式，颜色准确
- **无损压缩**: 保证图像质量

### GIF文件特点
- **动画效果**: 展示时间序列变化
- **循环播放**: 便于观察趋势
- **文件大小**: 通常1-2MB

### 文件命名规则
- 地图文件: `YYYY.png` (如2022.png)
- 动画文件: `beijing_map_animation.gif`
- 输出目录: `map_outputs/`

## 最佳实践

### 1. 数据准备
- 确保数据完整性和准确性
- 保持命名一致性
- 定期备份数据文件

### 2. 参数调整
- 先使用默认参数运行
- 根据效果逐步调整
- 保存满意的配置

### 3. 结果验证
- 检查每个年份的地图是否正确
- 验证颜色映射是否符合预期
- 确认GIF动画播放正常

### 4. 文档记录
- 记录自定义参数的修改
- 保存数据处理的步骤
- 备注特殊配置的原因

---

*如果遇到其他问题，请参考技术文档或查看代码注释。*
